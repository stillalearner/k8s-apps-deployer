---
kind: "Template"
apiVersion: "template.openshift.io/v1"
metadata: 
  name: "django-psql-persistent"
  namespace: {{ namespace }}
  annotations: 
    openshift.io/display-name: "Django + PostgreSQL"
    description: "An example Django application with a PostgreSQL database. For more information about using this template, including OpenShift considerations, see https://github.com/sclorg/django-ex/blob/master/README.md."
    tags: "quickstart,python,django"
    iconClass: "icon-python"
    openshift.io/long-description: "This template defines resources needed to develop a Django based application, including a build configuration, application deployment configuration, and database deployment configuration."
    openshift.io/provider-display-name: "Red Hat, Inc."
    openshift.io/documentation-url: "https://github.com/sclorg/django-ex"
    openshift.io/support-url: "https://access.redhat.com"
    template.openshift.io/bindable: "false"
message: "The following service(s) have been created in your project: ${NAME}, ${DATABASE_SERVICE_NAME}.

For more information about using this template, including OpenShift considerations, see https://github.com/sclorg/django-ex/blob/master/README.md."
labels: 
  template: "django-psql-persistent"
  app: "django-psql-persistent"
objects: 
- kind: "Secret"
  apiVersion: "v1"
  metadata: 
    name: "${NAME}"
  stringData: 
    database-user: "${DATABASE_USER}"
    database-password: "${DATABASE_PASSWORD}"
    django-secret-key: "${DJANGO_SECRET_KEY}"
- kind: "Service"
  apiVersion: "v1"
  metadata: 
    name: "${NAME}"
    annotations: 
      description: "Exposes and load balances the application pods"
      service.alpha.openshift.io/dependencies: '[{"name": "${DATABASE_SERVICE_NAME}", "kind": "Service"}]'
  spec: 
    ports: 
    - name: "web"
      port: 8080
      targetPort: 8080
    selector: 
      name: "${NAME}"
- kind: "Route"
  apiVersion: "route.openshift.io/v1"
  metadata: 
    name: "${NAME}"
  spec: 
    host: "${APPLICATION_DOMAIN}"
    to: 
      kind: "Service"
      name: "${NAME}"
- kind: "ImageStream"
  apiVersion: "image.openshift.io/v1"
  metadata: 
    name: "${NAME}"
    annotations: 
      description: "Keeps track of changes in the application image"
- kind: "BuildConfig"
  apiVersion: "build.openshift.io/v1"
  metadata: 
    name: "${NAME}"
    annotations: 
      description: "Defines how to build the application"
      template.alpha.openshift.io/wait-for-ready: "true"
  spec: 
    source: 
      type: "Git"
      git: 
        uri: "${SOURCE_REPOSITORY_URL}"
        ref: "${SOURCE_REPOSITORY_REF}"
      contextDir: "${CONTEXT_DIR}"
    strategy: 
      type: "Source"
      sourceStrategy: 
        from: 
          kind: "DockerImage"
          name: "registry.access.redhat.com/ubi8/python-39:latest"
        env: 
        - name: "PIP_INDEX_URL"
          value: "${PIP_INDEX_URL}"
    output: 
      to: 
        kind: "ImageStreamTag"
        name: "${NAME}:latest"
    triggers: 
    - type: "ImageChange"
    - type: "ConfigChange"
    - type: "GitHub"
      github: 
        secret: "${GITHUB_WEBHOOK_SECRET}"
    postCommit: 
      script: "./manage.py test"
- kind: "Deployment"
  apiVersion: "apps/v1"
  metadata: 
    name: "${NAME}"
    annotations: 
      description: "Defines how to deploy the application server"
      template.alpha.openshift.io/wait-for-ready: "true"
      image.openshift.io/triggers: '[{"from":{"kind":"ImageStreamTag","name":"${NAME}:latest"},"fieldPath": "spec.template.spec.containers[0].image"}]'
  spec: 
    strategy: 
      type: "Recreate"
    replicas: 1
    selector: 
      matchLabels: 
        name: "${NAME}"
    template: 
      metadata: 
        name: "${NAME}"
        labels: 
          name: "${NAME}"
      spec: 
        containers: 
        - name: "django-psql-persistent"
          image: " "
          command:
          - "/bin/bash"
          - "-c"
          - |
            set -e
            echo "Waiting for database to be ready..."
            max_attempts=30
            attempt=0
            until python -c "import psycopg2; psycopg2.connect(host='${DATABASE_SERVICE_NAME}', port=5432, user='${DATABASE_USER}', password='${DATABASE_PASSWORD}', database='${DATABASE_NAME}')" 2>/dev/null || [ $attempt -eq $max_attempts ]; do
              echo "Waiting for PostgreSQL (attempt $((attempt+1))/$max_attempts)..."
              attempt=$((attempt+1))
              sleep 2
            done
            if [ $attempt -eq $max_attempts ]; then
              echo "WARNING: Could not connect to database, attempting to continue anyway..."
            else
              echo "Database is ready!"
            fi
            echo "Running database migrations..."
            python manage.py migrate --noinput
            echo "Fixing hostname field length..."
            python manage.py shell <<'PYEOF'
            from django.db import connection
            with connection.cursor() as cursor:
                try:
                    cursor.execute("ALTER TABLE welcome_pageview ALTER COLUMN hostname TYPE VARCHAR(255);")
                    print("Successfully increased hostname field length to 255 characters")
                except Exception as e:
                    print(f"Note: Could not alter hostname field (may already be correct): {e}")
            PYEOF
            echo "Migrations completed!"
            echo "Starting Django application..."
            exec /usr/libexec/s2i/run
          ports: 
          - containerPort: 8080
          readinessProbe: 
            timeoutSeconds: 3
            initialDelaySeconds: 90
            httpGet: 
              path: "/health"
              port: 8080
          livenessProbe: 
            timeoutSeconds: 3
            initialDelaySeconds: 120
            httpGet: 
              path: "/health"
              port: 8080
          env: 
          - name: "DATABASE_SERVICE_NAME"
            value: "${DATABASE_SERVICE_NAME}"
          - name: "DATABASE_ENGINE"
            value: "${DATABASE_ENGINE}"
          - name: "DATABASE_NAME"
            value: "${DATABASE_NAME}"
          - name: "DATABASE_USER"
            valueFrom: 
              secretKeyRef: 
                name: "${NAME}"
                key: "database-user"
          - name: "DATABASE_PASSWORD"
            valueFrom: 
              secretKeyRef: 
                name: "${NAME}"
                key: "database-password"
          - name: "APP_CONFIG"
            value: "${APP_CONFIG}"
          - name: "DJANGO_SECRET_KEY"
            valueFrom: 
              secretKeyRef: 
                name: "${NAME}"
                key: "django-secret-key"
          resources: 
            limits: 
              memory: "${MEMORY_LIMIT}"
- kind: "PersistentVolumeClaim"
  apiVersion: "v1"
  metadata: 
    name: "${DATABASE_SERVICE_NAME}"
  spec: 
    accessModes: 
    - "ReadWriteOnce"
    resources: 
      requests: 
        storage: "${VOLUME_CAPACITY}"
- kind: "Service"
  apiVersion: "v1"
  metadata: 
    name: "${DATABASE_SERVICE_NAME}"
    annotations: 
      description: "Exposes the database server"
  spec: 
    ports: 
    - name: "postgresql"
      port: 5432
      targetPort: 5432
    selector: 
      name: "${DATABASE_SERVICE_NAME}"
- kind: "Deployment"
  apiVersion: "apps/v1"
  metadata: 
    name: "${DATABASE_SERVICE_NAME}"
    annotations: 
      description: "Defines how to deploy the database"
      template.alpha.openshift.io/wait-for-ready: "true"
  spec: 
    strategy: 
      type: "Recreate"
    replicas: 1
    selector: 
      matchLabels: 
        name: "${DATABASE_SERVICE_NAME}"
    template: 
      metadata: 
        name: "${DATABASE_SERVICE_NAME}"
        labels: 
          name: "${DATABASE_SERVICE_NAME}"
      spec: 
        volumes: 
        - name: "${DATABASE_SERVICE_NAME}-data"
          persistentVolumeClaim: 
            claimName: "${DATABASE_SERVICE_NAME}"
        containers: 
        - name: "postgresql"
          image: "registry.redhat.io/rhel10/postgresql-16:latest"
          ports: 
          - containerPort: 5432
          env: 
          - name: "POSTGRESQL_USER"
            valueFrom: 
              secretKeyRef: 
                name: "${NAME}"
                key: "database-user"
          - name: "POSTGRESQL_PASSWORD"
            valueFrom: 
              secretKeyRef: 
                name: "${NAME}"
                key: "database-password"
          - name: "POSTGRESQL_DATABASE"
            value: "${DATABASE_NAME}"
          volumeMounts: 
          - name: "${DATABASE_SERVICE_NAME}-data"
            mountPath: "/var/lib/pgsql/data"
          readinessProbe: 
            timeoutSeconds: 1
            initialDelaySeconds: 5
            exec: 
              command: 
              - "/usr/libexec/check-container"
          livenessProbe: 
            timeoutSeconds: 10
            initialDelaySeconds: 120
            exec: 
              command: 
              - "/usr/libexec/check-container"
              - "--live"
          resources: 
            limits: 
              memory: "${MEMORY_POSTGRESQL_LIMIT}"
parameters: 
- name: "NAME"
  displayName: "Name"
  description: "The name assigned to all of the frontend objects defined in this template."
  required: true
  value: "django-psql-persistent"
- name: "NAMESPACE"
  displayName: "Namespace"
  required: true
  description: "The OpenShift Namespace where the ImageStream resides."
  value: "openshift"
- name: "PYTHON_VERSION"
  displayName: "Version of Python Image"
  description: "Version of Python image to be used (3.6-ubi8, 3.8-ubi8, 3.9-ubi8, or latest)."
  value: "3.9-ubi8"
  required: true
- name: "POSTGRESQL_VERSION"
  displayName: "Version of PostgreSQL Image"
  description: "Version of PostgreSQL image to be used (10-el8, 12-el8, or latest)."
  value: "12-el8"
  required: true
- name: "MEMORY_LIMIT"
  displayName: "Memory Limit"
  required: true
  description: "Maximum amount of memory the Django container can use."
  value: "512Mi"
- name: "MEMORY_POSTGRESQL_LIMIT"
  displayName: "Memory Limit (PostgreSQL)"
  required: true
  description: "Maximum amount of memory the PostgreSQL container can use."
  value: "512Mi"
- name: "VOLUME_CAPACITY"
  displayName: "Volume Capacity"
  description: "Volume space available for data, e.g. 512Mi, 2Gi"
  value: "1Gi"
  required: true
- name: "SOURCE_REPOSITORY_URL"
  displayName: "Git Repository URL"
  required: true
  description: "The URL of the repository with your application source code."
  value: "https://github.com/sclorg/django-ex.git"
- name: "SOURCE_REPOSITORY_REF"
  displayName: "Git Reference"
  description: "Set this to a branch name, tag or other ref of your repository if you are not using the default branch."
- name: "CONTEXT_DIR"
  displayName: "Context Directory"
  description: "Set this to the relative path to your project if it is not in the root of your repository."
- name: "APPLICATION_DOMAIN"
  displayName: "Application Hostname"
  description: "The exposed hostname that will route to the Django service, if left blank a value will be defaulted."
  value: ""
- name: "GITHUB_WEBHOOK_SECRET"
  displayName: "GitHub Webhook Secret"
  description: "Github trigger secret.  A difficult to guess string encoded as part of the webhook URL.  Not encrypted."
  generate: "expression"
  from: "[a-zA-Z0-9]{32}"
- name: "DATABASE_SERVICE_NAME"
  displayName: "Database Service Name"
  required: true
  value: "postgresql"
- name: "DATABASE_ENGINE"
  displayName: "Database Engine"
  required: true
  description: "Database engine: postgresql, mysql or sqlite (default)."
  value: "postgresql"
- name: "DATABASE_NAME"
  displayName: "Database Name"
  required: true
  value: "default"
- name: "DATABASE_USER"
  displayName: "Database Username"
  required: true
  value: "django"
- name: "DATABASE_PASSWORD"
  displayName: "Database User Password"
  generate: "expression"
  from: "[a-zA-Z0-9]{16}"
- name: "APP_CONFIG"
  displayName: "Application Configuration File Path"
  description: "Relative path to Gunicorn configuration file (optional)."
- name: "DJANGO_SECRET_KEY"
  displayName: "Django Secret Key"
  description: "Set this to a long random string."
  generate: "expression"
  from: '[\w]{32}'
- name: "PIP_INDEX_URL"
  displayName: "Custom PyPi Index URL"
  description: "The custom PyPi index URL"
  value: ""