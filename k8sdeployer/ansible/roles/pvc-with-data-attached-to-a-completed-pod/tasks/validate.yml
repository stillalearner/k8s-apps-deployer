---
- name: Check if job exists
  k8s_info:
    api_version: batch/v1
    kind: Job
    namespace: "{{ namespace }}"
    name: data-generation-job
    host: "{{ server }}"
    api_key: "{{ token }}"
    verify_ssl: "{{ verify_ssl }}"
  register: job_info

- name: Assert that the job exists
  assert:
    that:
      - job_info.resources | length > 0
    fail_msg: "Job data-generation-job does not exist"
    success_msg: "Job data-generation-job exists"

- name: Wait for job to complete successfully
  k8s_info:
    api_version: batch/v1
    kind: Job
    namespace: "{{ namespace }}"
    name: data-generation-job
    host: "{{ server }}"
    api_key: "{{ token }}"
    verify_ssl: "{{ verify_ssl }}"
  register: job_info
  until:
    - job_info.resources | length > 0
    - job_info.resources[0].status.succeeded | default(0) == 1
  retries: 20
  delay: 5
  ignore_errors: yes

- name: Wait for pod created by job to exist and complete
  k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ namespace }}"
    label_selectors:
      - "job-name=data-generation-job"
    host: "{{ server }}"
    api_key: "{{ token }}"
    verify_ssl: "{{ verify_ssl }}"
  register: pod_info
  until:
    - pod_info.resources | length > 0
    - "'Succeeded' in (pod_info.resources | map(attribute='status.phase') | list)"
  retries: 12
  delay: 10

- name: Assert that the pod exists and has completed
  assert:
    that:
      - pod_info.resources | length > 0
      - "'Succeeded' in (pod_info.resources | map(attribute='status.phase') | list)"
    fail_msg: "Pod for job data-generation-job does not exist or has not completed"
    success_msg: "Pod for job data-generation-job exists and has completed"
